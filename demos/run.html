<html>
<head>
<title>Run Run Run!</title>
<script type="text/javascript" src="../src/jslash.js" ></script>
<script type="text/javascript">
(function() {
  jslash.prefetchImg([ "../img/ranger_m.png", "../img/mine.png"]);

  var DISTANCE = 100;
  var GAP = 16;
  var ROCKS_SPEED = 10 ;
  var TXTPADDING = 10;

  var player, tileMap, canvas;
  var obstacles = [];
  var draftObstacles = [];

  function createMine() {
    var obstacle = new jslash.Sprite(jslash.images['../img/mine.png']);
    obstacle.scale(0.5);
    var x = Math.random() * (tileMap.width * tileMap.tilewidth - obstacle.width() );
    var y = Math.random() * (tileMap.height * tileMap.tileheight - obstacle.height() );
    obstacle.absPosition = new jslash.Point(x,y);
    jslash.mix(obstacle,new jslash.behaviors.Collidable(jslash.Rectangle,'canvasRect'));
    obstacles.push(obstacle);
    return obstacle;
  }

  jslash.ready(function() {
    tileMap = new jslash.TiledTileset();
    tileMap.load("../tmx/run_background.json");
    canvas = new jslash.Canvas('canvas');
    canvas.width(400);
    canvas.height(600);
    var rgerImg = jslash.images['../img/ranger_m.png'];
    var frames = [ new jslash.Frame(rgerImg,new jslash.Rect(0,0,32,36)),
                   new jslash.Frame(rgerImg,new jslash.Rect(32,0,32,36)),
                   new jslash.Frame(rgerImg,new jslash.Rect(64,0,32,36)) ];
   
    player = new jslash.AnimatedSprite(frames);
    (function() {
      var ticks = 0;
      player.onrefresh = function() {
        if (ticks > 30) {
          this.next();
          ticks = 0;
        }
        else { ticks++; }
      };
    })();
    jslash.mix(player, new jslash.behaviors.Collidable(jslash.Rect,'canvasRect'));
    //player.onrefresh = jslash.AnimatedSprite.makeRefresh();

    var info = new jslash.Text("Use WASD to move the ranger!",0);
    info.color = 'white'; info.font = 'Verdana'; info.size = 16;
    info.y = canvas.height() - info.height() - TXTPADDING;
    info.weight = 'bold';

    speeds = { A: { x: -GAP, y : 0, scroll: function() { return tileMap.scrollLeft(canvas); } },
               S: { x: 0, y: GAP, scroll: function() { return tileMap.scrollDown(canvas); }},
               D: { x: GAP, y: 0, scroll: function() { return tileMap.scrollRight(canvas); }},
               W: { x: 0, y: -GAP, scroll: function() { return tileMap.scrollUp(canvas); }} };

    function makeSpeedFunc(key) {
      var speed = speeds[key];
      var makedFunc = function() {
        var p = player.position();
        p.x += speed.x;
        p.y += speed.y;
        var pp = tileMap.toAbsolute(new jslash.Point(p.x,p.y));
        var cr = jslash.deepcopy(player.canvasRect());
        cr.x = pp.x; cr.y = pp.y;
        if (tileMap.isFreeArea(cr)) {
          if (!speed.scroll() ) {
            player.position(p.x,p.y);
          }
        }
      };
      return makedFunc;
    }

    jslash.addKeyEvent(jslash.KEYS.A,makeSpeedFunc('A'));
    jslash.addKeyEvent(jslash.KEYS.D,makeSpeedFunc('D'));
    jslash.addKeyEvent(jslash.KEYS.S,makeSpeedFunc('S'));
    jslash.addKeyEvent(jslash.KEYS.W,makeSpeedFunc('W'));

    tileMap.ready(function() {

      jslash.times(25,createMine);

      while ( tileMap.scrollDown(canvas) );

      player.canvasRect(new jslash.Rect(0,0,player.width(),player.height()));
      player.center(canvas.center().x,
                    canvas.center().y);
  
      jslash.onupdate = function(dt) {
        //player position normalization
        var p = player.position();
        if ( p.x < 0 ) p.x = 0;
        if ( p.y < 0 ) p.y = 0;
        if ( p.x > canvas.width() - player.width()) p.x = canvas.width() - player.width();
        if ( p.y > canvas.height() - player.height()) p.y = canvas.height() - player.height();
        player.position(p.x,p.y);
    
        draftObstacles = [];

        jslash.each(obstacles,function(i,e) {
          var p = tileMap.toRelative(e.absPosition);
          if (p.x >= 0 && p.y >= 0 && p.x < canvas.width() && p.y < canvas.height() ) {
            e.position(p.x,p.y);
            draftObstacles.push(e);
          }
        });
      
        jslash.each(draftObstacles,function(i,e) {
          if (e.collides(player)) {
            var c = parseFloat(jslash.ById('show_collision').innerHTML);
            c++;
            jslash.ById('show_collision').innerHTML = c;
          }
        });
      };

      jslash.onrefresh = function() {
        canvas.draw(tileMap);
        canvas.draw(info);
        jslash.each(draftObstacles,function(i,e) {
                      canvas.draw(e);       
                    });
        canvas.draw(player);
      };

      jslash.startWithAnimationFrame(canvas);

    });
  });

})();
</script>
</head>
<body>
<div align="center">
<canvas id="canvas" ></canvas>
</div>
<div>
<h1 id="show_collision">0</h1>
</div>
</body>
</html>
