<html>
<head>
<title>Pong Demo</title>
<script type="text/javascript" src="../src/jslash.js" ></script>
<script>

var main;

(function() {
  jslash.prefetchImg([ "../img/palet.png", "../img/ball.png" ]);
  main = function() {
    var canvas = new jslash.Canvas('canvas');
    var palet = jslash.images['../img/palet.png'];
    var ball = jslash.images['../img/ball.png'];
    var p1 = new jslash.Sprite(palet);
    var p2 = new jslash.Sprite(palet);
    var y = canvas.height()/2 - p1.height();
    p1.position(5,y);
    p2.position(canvas.width()-5-p1.width(),y);
    var sBall = new jslash.Sprite(ball);
    //TODO change this when center method be added to sprite object
    sBall.center(canvas.width()/2,canvas.height()/2);
    jslash.mix(sBall,new jslash.behaviors.Moveable(250,0));
    jslash.addKeyEvent(jslash.KEYS.W,function() {
                            var prevPos = p1.canvasRect();
                            prevPos.y -= 10;
                            p1.canvasRect(prevPos);
                          });
    jslash.addKeyEvent(jslash.KEYS.S,function() {
                            var prevPos = p1.canvasRect();
                            prevPos.y += 10;
                            p1.canvasRect(prevPos); 
                          });

    jslash.fps = 10;

    function normalize(s) {
      var r = s.canvasRect();
      r.x = r.x < 0 ? 0 : r.x;
      r.y = r.y < 0 ? 0 : r.y;
      r.x = r.x+r.width >= canvas.width() ? canvas.width()-r.width-1 : r.x;
      r.y = r.y+r.height >= canvas.height() ? canvas.height()-r.height-1 : r.y; 
      s.canvasRect(r);
    }

    function handleCollision(ball,palet) {
      if (ball.canvasRect().collides(palet.canvasRect())) { 
        ball.speed.x = -ball.speed.x;
        var cy = palet.center().y;
        var bcy = ball.center().y;
        var height = palet.canvasRect().height;
        ball.speed.y = Math.abs(ball.speed.x) * (bcy - cy)/height*2;

      }
    }

    var enemyMovementsCounter = 0;

    jslash.onupdate = function(dt) {
      if (jslash.borders.collides(p1.canvasRect())) {
        normalize(p1);
      }
      if (jslash.borders.collides(p2.canvasRect())) {
        normalize(p2);
      }

      handleCollision(sBall,p1);
      handleCollision(sBall,p2);

      if (jslash.borders.collides(sBall.canvasRect())) {
          if ( sBall.position().x >= 0 && sBall.position().x + sBall.canvasRect().width < jslash.borders.width) {
            sBall.speed.y = -sBall.speed.y; 
          }
          else {
            //TODO: update the score counter.
          }
      }
      enemyMovementsCounter++;
      if (enemyMovementsCounter >= 20) {
        var by = sBall.position().y;
        if (by <= p2.position().y) {
          p2.position(p2.position().x,p2.position().y - 10);
        }
        else {
          p2.position(p2.position().x,p2.position().y + 10);
        }
        enemyMovementsCounter=0;
      }
      sBall.move(dt);
    };
    jslash.onrefresh = function() {
      canvas.draw(p1);
      canvas.draw(p2);
      canvas.draw(sBall);
    };
    jslash.start(canvas);
  };
})();

</script>
</head>
<body onload="main();">
<div align="center">
<canvas id="canvas" width="1066" height="600" ></canvas>
</div>
</body>
</html>
